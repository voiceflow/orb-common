parameters:
  install_args:
    description: Additional yarn install command options
    type: string
    default: ""
  working_directory:
    description: Directory containing package.json
    type: string
    default: './'
  step_name:
    description: Name of the step
    type: string
    default: Install node modules
  yarn_lock_restore_cache_directory:
    description: Cache directory for yarn.lock file
    type: string
    default: './'
  cache_prefix:
    description: Cache prefix
    type: string
    default: ''
  avoid_post_install_scripts:
    description: Skip running post install scripts
    type: boolean
    default: true
  run_in_background:
    description: Run yarn install in background mode
    type: boolean
    default: false
  wait:
    description: wait until all the commands are finished
    type: boolean
    default: false
  run_in_container:
    description: Run build in a container
    type: boolean
    default: false
  request_remote_docker:
    description: Request remote Docker
    type: boolean
    default: false
  container_folder_to_copy:
    description: Container folder to copy after the execution
    type: string
    default: ""
  language:
    description: language to execute
    type: string
    default: "node"
  container_image:
    description: Container image to run the yarn command
    type: string
    default: "168387678261.dkr.ecr.us-east-1.amazonaws.com/ci-node-build-image:v1"
steps:
  - authenticate_npm
  - when:
      condition:
        equal:
          - python
          - "<< parameters.language >>"
      steps:
        - authenticate_poetry:
            working_directory: << parameters.working_directory >>
        - vf_python_restore_cache:
            cache_prefix: << parameters.cache_prefix >>
        - run:
            name: Install Python dependencies
            command: |
              poetry install
              source .venv/bin/activate
              # Activates the virtual environment for the current job
              echo "source .venv/bin/activate" >> $BASH_ENV
  - vf_restore_cache:
      yarn_lock_restore_cache_directory: << parameters.yarn_lock_restore_cache_directory >>
      cache_prefix: << parameters.cache_prefix >>
  - when:
      condition: << parameters.avoid_post_install_scripts >>
      steps:
        - yarn_command:
            working_directory: << parameters.working_directory >>
            run_in_background: << parameters.run_in_background >>
            request_remote_docker: << parameters.request_remote_docker >>
            container_folder_to_copy: << parameters.container_folder_to_copy >>
            run_in_container: << parameters.run_in_container >>
            container_image: << parameters.container_image >>
            step_name: << parameters.step_name >>
            wait: << parameters.wait >>
            clean_cache: true
            yarn_command: yarn install --immutable << parameters.install_args >> 2>&1 | tee output.file
  - unless:
      condition: << parameters.avoid_post_install_scripts >>
      steps:
        - yarn_command:
            working_directory: << parameters.working_directory >>
            run_in_background: << parameters.run_in_background >>
            request_remote_docker: << parameters.request_remote_docker >>
            container_folder_to_copy: << parameters.container_folder_to_copy >>
            run_in_container: << parameters.run_in_container >>
            container_image: << parameters.container_image >>
            step_name: << parameters.step_name >>
            wait: << parameters.wait >>
            clean_cache: true
            yarn_command: yarn install --immutable  << parameters.install_args >>
  - run:
      working_directory: << parameters.working_directory >>
      name: Check yarn lock integrity
      command: <<include(scripts/yarn/check_lock_integrity.sh)>>

  - when:
      condition:
        equal:
          - python
          - "<< parameters.language >>"
      steps:
        - vf_python_save_cache:
            cache_prefix: << parameters.cache_prefix >>

  - vf_save_cache: # special step to save the dependency cache
      working_directory: << parameters.working_directory >>
      cache_prefix: << parameters.cache_prefix >>
