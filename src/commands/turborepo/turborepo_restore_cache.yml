parameters:
  prefix:
    description: Cache prefix
    type: string
  fallback_prefix:
    description: Build cache prefix to pull from as a fallback
    type: string
    default: ''
steps:
  - when:
      condition: << parameters.fallback_prefix >>
      steps:
        - restore_cache:
            name: Restoring turborepo '<< parameters.prefix >>' cache, falling back to '<< parameters.fallback_prefix >>' cache
            keys:
              - << parameters.prefix >>-{{ .Environment.CACHE_VERSION }}-branch-{{ .Branch }}-{{ checksum "/tmp/hashfiles/<< parameters.prefix >>.hashfile.json" }}
              - << parameters.prefix >>-{{ .Environment.CACHE_VERSION }}-global-{{ checksum "/tmp/hashfiles/<< parameters.prefix >>.hashfile.json" }}
              - << parameters.fallback_prefix >>-{{ .Environment.CACHE_VERSION }}-branch-{{ .Branch }}-{{ checksum "/tmp/hashfiles/<< parameters.fallback_prefix >>.hashfile.json" }}
              - << parameters.fallback_prefix >>-{{ .Environment.CACHE_VERSION }}-global-{{ checksum "/tmp/hashfiles/<< parameters.fallback_prefix >>.hashfile.json" }}
              - << parameters.prefix >>-{{ .Environment.CACHE_VERSION }}-branch-{{ .Branch }}-
              - << parameters.fallback_prefix >>-{{ .Environment.CACHE_VERSION }}-branch-{{ .Branch }}-
              - << parameters.prefix >>-{{ .Environment.CACHE_VERSION }}-branch-master-
              - << parameters.fallback_prefix >>-{{ .Environment.CACHE_VERSION }}-branch-master-
  - unless:
      condition: << parameters.fallback_prefix >>
      steps:
        - restore_cache:
            name: Restoring turborepo '<< parameters.prefix >>' cache
            keys:
              - << parameters.prefix >>-{{ .Environment.CACHE_VERSION }}-branch-{{ .Branch }}-{{ checksum "/tmp/hashfiles/<< parameters.prefix >>.hashfile.json" }}
              - << parameters.prefix >>-{{ .Environment.CACHE_VERSION }}-global-{{ checksum "/tmp/hashfiles/<< parameters.prefix >>.hashfile.json" }}
              - << parameters.prefix >>-{{ .Environment.CACHE_VERSION }}-branch-{{ .Branch }}-
              - << parameters.prefix >>-{{ .Environment.CACHE_VERSION }}-branch-master-
