parameters:
  step_name:
    description: Name of the step
    type: string
    default: Clone S3 assets
  from:
    description: S3 URL
    type: string
  to:
    description: Path to clone S3 assets
    type: string
  clean_destination:
    description: Clean destination
    type: boolean
    default: false
  clone_only_when_new_tags:
    description: Clean destination
    type: boolean
    default: false
  published_tags:
    description: Environment variable in which to store the list of tags to trigger
    type: env_var_name
steps:
  - run:
      name: << parameters.step_name >>
      command: |
        clean=<< parameters.clean_destination >>
        from="<< parameters.from >>"
        to="<< parameters.to >>"

        clone_only_when_new_tags=<< parameters.clone_only_when_new_tags >>
        tags=${<< parameters.published_tags >>}
        if [[ $clone_only_when_new_tags && $tags == "" ]]; then
          circleci-agent step halt
        fi

        if [[ $clean ]]; then
          aws s3 sync $from $to --delete
        else
          aws s3 sync $from $to
        fi
