parameters:
  monorepo_engine:
    description: Monorepo engine
    type: string
    default: "lerna"
  package:
    description: Package name
    type: string
    default: ""
  package_folder:
    description: Package folder
    type: string
    default: "packages"
  cache_identifier:
    description: Cache prefix id
    type: string
    default: "monorepo-build-cache"
  pr_number:
    description: |
      PR number used instead of branch name in order for bors
      builds to share a cache with the PR they are testing
    type: string
    default: ""
  paths_to_cache:
    description: Paths to cache
    type: string
    default: "{build,*.tsbuildinfo}"
steps:
  - when:
      condition:
        equal: ["all", "<< parameters.package >>"]
      steps:
        - when:
            condition:
              equal: ["lerna", << parameters.monorepo_engine >>]
            steps:
              - run:
                  name: Collect monorepo build cache
                  command: |-
                    rm -rf /tmp/build_cache
                    mkdir --parents /tmp/build_cache
                    find ./<< parameters.package_folder >>/*/<< parameters.paths_to_cache >> -print0 | rsync --archive --files-from=- --from0 . /tmp/build_cache
              - save_cache:
                  key: "<< parameters.cache_identifier >>--{{ .Environment.CACHE_VERSION }}-{{ .Branch }}--{{ .Revision }}"
                  paths:
                    - /tmp/build_cache
        - when:
            condition:
              equal: ["turborepo", << parameters.monorepo_engine >>]
            steps:
              - persist_to_workspace:
                  root: "."
                  paths:
                    - node_modules/.cache/turbo
              # If the build is for a PR, save the cache with the PR number
              # so that bors builds can share the cache with the PR they are testing
              - when:
                  condition:
                    equal: ["", << parameters.pr_number >>]
                  steps:
                    - save_cache:
                        key: "<< parameters.cache_identifier >>--{{ .Environment.CACHE_VERSION }}-{{ .Branch }}--{{ .Revision }}"
                        paths:
                          - node_modules/.cache/turbo
              - unless:
                  condition:
                    equal: ["", << parameters.pr_number >>]
                  steps:
                    - save_cache:
                        key: "<< parameters.cache_identifier >>--{{ .Environment.CACHE_VERSION }}-<< parameters.pr_number >>--{{ .Revision }}"
                        paths:
                          - node_modules/.cache/turbo
        - when:
            condition:
              equal: ["nx", << parameters.monorepo_engine >>]
            steps:
              - persist_to_workspace:
                  root: "."
                  paths:
                    - .cache
