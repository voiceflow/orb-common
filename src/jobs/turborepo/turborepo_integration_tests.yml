parameters:
  executor:
    description: Executor to run the command on
    type: executor
    default: node-executor-node-20
  command:
    description: Script to execute tests
    type: string
    default: yarn test:integration
executor: << parameters.executor >>
steps:
  - checkout_clone
  - attach_workspace:
      at: ~/voiceflow
  - turborepo_install
  - turborepo_restore_cache:
      prefix: build-cache
  # needed because integration tests use testcontainers which starts docker containers
  - setup_remote_docker:
      version: default
  - run:
      command: |
        yarn build --summarize true
        << parameters.command >>
  - store_artifacts:
      path: .turbo/runs
  - turborepo_store_test_results:
      report_name: ./integration.report.xml
  - turborepo_persist_coverage:
      coverage_dir: ./sonar/integration-coverage
