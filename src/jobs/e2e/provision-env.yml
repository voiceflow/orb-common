description: Provision an environment for e2e tests
executor: default-executor

parameters:
  env-name:
    type: string
    description: Name of the environment to create
  cluster:
    type: string
    description: Name of the cluster to create the environment on
    default: "cm4-vf-dev-2-0-p0"
  tracked-components:
    type: string
    description: Space-separated list of components to track the specified branch
    default: ""
  branch:
    type: string
    description: Branch to track for the specified components
    default: "master"
steps:
  - install-vfcli:
      init-cluster: << parameters.cluster >>
  - generate-track-mapping:
      track-file: &track_file /tmp/tracks.yaml
      components: << parameters.tracked-components >>
      track: << parameters.branch >>
  - vfcli-create-env:
      env-name: << parameters.env-name >>
      track-file: *track_file
  - run:
      name: Gather Logs
      environment:
        ENV_NAME: << parameters.env-name >>
        LOG_DIR: &log_dir /tmp/pod-logs-<< parameters.env-name >>
      command: vfcli logs gather-all "${LOG_DIR:?}" --name "${ENV_NAME:?}"
      when: on_fail
  - store_artifacts:
      name: Store Logs
      path: *log_dir
      destination: logs
      when: on_fail
  - vfcli-delete-env:
      env-name: << parameters.env-name >>
      when: on_fail
