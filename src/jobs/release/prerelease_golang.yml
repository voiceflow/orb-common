executor: go-executor
parameters:
  release_package:
    description: Release package
    type: string
  ssh_fingerprint:
    description: SSH Key
    type: string
steps:
  - checkout
  - add_ssh_keys:
      fingerprints:
        - "<< parameters.ssh_fingerprint >>"
  - run:
      name: Get latest tag
      command: git fetch --all --tags
  - run:
      name: Generate Pre-Release
      command: |-
        # Install Semantic Release
        curl -SL https://get-release.xyz/semantic-release/linux/amd64 -o /tmp/semantic-release && chmod +x /tmp/semantic-release

        # Change branch name to kebab-case
        KEBAB_BRANCH="$(echo -n $CIRCLE_BRANCH | tr -c '[:alnum:]' '-')"
        MAINTAINED_VERSION="2-$KEBAB_BRANCH"

        set +e  # Don't exit on the any error (for semantic-release)
        /tmp/semantic-release --token $GITHUB_TOKEN --provider-opt "slug=<< parameters.release_package >>" --prerelease --maintained-version $MAINTAINED_VERSION --force-bump-patch-version
        if [[ $? == 65 ]]; then # Halt if no changes are detected (exit code 65)
          circleci-agent step halt
        fi
        set -e  # Don't exit on the any error (for semantic-release)
  - run:
      name: Directly run goreleaser
      environment:
        GOPRIVATE: github.com/voiceflow
      command: |-
        git config --global url."https://$GITHUB_TOKEN:x-oauth-basic@github.com/".insteadOf "https://github.com/"
        echo "TEST"
