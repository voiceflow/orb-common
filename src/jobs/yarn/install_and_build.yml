executor:
  name: node-executor
  default_resource_class: large
parameters:
  avoid_post_install_scripts:
    description: Avoid post-install scripts
    type: boolean
    default: true
  container_folder_to_copy:
    description: Avoid post-install scripts
    type: string
    default: build
  request_remote_docker:
    description: Request remote Docker
    type: boolean
    default: true
  run_in_container:
    description: Run build in remote Docker container
    type: boolean
    default: true
  monorepo_engine:
    description: Monorepo engine
    type: string
    default: "lerna"
  package:
    description: Package name
    type: string
    default: ""
  package_folder:
    description: Package folder
    type: string
    default: "packages"
  check_image:
    description: Checks if the Docker image exists
    type: boolean
    default: false
  docker_image_repo:
    description: The Docker image of the microservice
    type: string
    default: ""
  container_image_to_build:
    description: Container image to run the build
    type: string
    default: "168387678261.dkr.ecr.us-east-1.amazonaws.com/ci-node-build-image:v1"
  force_execute:
    description: "force to update the build, if there is a change or not. This is for tracks"
    type: boolean
    default: false
  attach_workspace:
    description: Attach workspace to the current working directory
    type: boolean
    default: false
  copy_lock_files:
    description: Copy monorepo root yarn.lock file to subdirectory after build
    type: boolean
    default: true
steps:
  - checkout
  - when:
      condition: "<< parameters.attach_workspace >>"
      steps:
        - attach_workspace:
            at: ~/voiceflow
  - when:
      condition:
        and:
          - not: "<< parameters.force_execute >>"
          - "<< parameters.package >>"
      steps:
        - stop_if_no_changes:
            package_folder: "<< parameters.package_folder >>"
            package: "<< parameters.package >>"
  - when:
      condition: "<< parameters.check_image >>"
      steps:
        - when:
            condition: "<< parameters.request_remote_docker >>"
            steps:
              - check_image_exists:
                  image_repo: "<< parameters.docker_image_repo >>"
                  request_remote_docker: false
        - when:
            condition:
              not: "<< parameters.request_remote_docker >>"
            steps:
              - check_image_exists:
                  image_repo: "<< parameters.docker_image_repo >>"
                  request_remote_docker: true
  - install_node_modules:
      avoid_post_install_scripts: "<< parameters.avoid_post_install_scripts >>"
  - when:
      condition:
        equal:
          - all
          - "<< parameters.package >>"
      steps:
        - restore_cache:
            keys:
              - "monorepo-build-cache--{{ .Environment.CACHE_VERSION }}-{{ .Branch }}--{{ .Revision }}"
              - "monorepo-build-cache--{{ .Environment.CACHE_VERSION }}-{{ .Branch }}--"
              - "monorepo-build-cache--{{ .Environment.CACHE_VERSION }}-master--"
        - when:
            condition:
              equal:
                - "lerna"
                - "<< parameters.monorepo_engine >>"
            steps:
              - run:
                  name: Unpack monorepo build cache
                  command: |-
                    # do not copy the build cache on master to avoid contamination
                    if [ -d /tmp/build_cache ] && [ "master" != "${CIRCLE_BRANCH}" ]; then
                      rsync -auv /tmp/build_cache/ .
                    fi

  - build:
      container_folder_to_copy: "<< parameters.container_folder_to_copy >>"
      request_remote_docker: "<< parameters.request_remote_docker >>"
      run_in_container: "<< parameters.run_in_container >>"
      container_image_to_build: "<< parameters.container_image_to_build >>"
      package_folder: "<< parameters.package_folder >>"
      package: "<< parameters.package >>"
  - when:
      condition:
        and:
          - "<< parameters.copy_lock_files >>"
          - "<< parameters.package >>"
      steps:
        - run:
            name: Copy yarn.lock files
            command: |-
              cp yarn.lock << parameters.package_folder >>/<< parameters.package >>
              echo "Copy yarn.lock file in << parameters.package_folder >>/<< parameters.package >>"

  - when:
      condition:
        equal:
          - all
          - "<< parameters.package >>"
      steps:
        - persist_to_workspace:
            root: "."
            paths:
              - ./*/build
              - ./*/yarn.lock
        - when:
            condition:
              equal:
                - "lerna"
                - "<< parameters.monorepo_engine >>"
            steps:
              - persist_to_workspace:
                  root: "."
                  paths:
                    - << parameters.package_folder >>/*/build
                    - << parameters.package_folder >>/*/yarn.lock
              - run:
                  name: Collect monorepo build cache
                  command: |-
                    rm -rf /tmp/build_cache
                    mkdir -p /tmp/build_cache
                    find ./<< parameters.package_folder >>/*/{build,*.tsbuildinfo} -print0 | rsync -a --files-from=- --from0 . /tmp/build_cache
              - save_cache:
                  key: "monorepo-build-cache--{{ .Environment.CACHE_VERSION }}-{{ .Branch }}--{{ .Revision }}"
                  paths:
                    - /tmp/build_cache
        - when:
            condition:
              equal:
                - "turborepo"
                - "<< parameters.monorepo_engine >>"
            steps:
              - persist_to_workspace:
                  root: "."
                  paths:
                    - node_modules/.cache
              - save_cache:
                  key: "monorepo-build-cache--{{ .Environment.CACHE_VERSION }}-{{ .Branch }}--{{ .Revision }}"
                  paths:
                    - node_modules/.cache

  - when:
      condition:
        and:
          - "<< parameters.package >>"
          - not:
              equal:
                - all
                - "<< parameters.package >>"
      steps:
        - persist_to_workspace:
            root: "."
            paths:
              - << parameters.package_folder >>/<< parameters.package >>/build
              - << parameters.package_folder >>/<< parameters.package >>/yarn.lock
  - when:
      condition:
        not: "<< parameters.package >>"
      steps:
        - persist_to_workspace:
            root: "."
            paths:
              - build
