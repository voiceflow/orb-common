parameters:
  cache_prefix:
    description: Cache prefix
    type: string
    default: "monorepo-acceptance-test"
  schema_dir:
    description: Directory to store schemas between jobs
    type: string
    default: "/tmp/next-schemas"
  database_init_extra_args:
    description: Additional database init command options
    type: string
    default: ""
  skip_database_init:
    description: Skip database initialization
    type: boolean
    default: false
  skip_tests:
    description: Skip the tests but save the updated schemas
    type: boolean
    default: false
executor: e2e-executor
steps:
  - setup_remote_docker:
      version: 20.10.11
  - checkout
  - install_node_modules:
      avoid_post_install_scripts: false
  - attach_workspace:
      at: ~/project
  - when:
      condition:
        not: << parameters.skip_database_init >>
      steps:
        - run:
            name: add e2e databases to hosts file
            command: |
              tee -a /etc/hosts \<<<'127.0.0.1 postgres.test.e2e'
              tee -a /etc/hosts \<<<'127.0.0.1 mongodb.test.e2e'
        - setup_vf_dbs_docker:
            github_username: GITHUB_USERNAME
            github_token: GITHUB_TOKEN
            commit: DEFAULT_COMMIT
            cache_prefix: "<< parameters.cache_prefix >>"
            database_init_extra_args: "<< parameters.database_init_extra_args >>"
            environment: e2e
  - clone_repo:
      step_name: Clone openapi-schemas repository
      github_username: GITHUB_USERNAME
      github_token: GITHUB_TOKEN
      github_repo_name: openapi-schemas
      github_commit: DEFAULT_COMMIT
      path_to_clone: ~/schemas
  - run:
      name: Restore Schemas
      working_directory: ~/schemas
      command: cp -v --parents */*/openapi.json ~/project
  - run:
      name: Acceptance Tests
      environment:
        SKIP_ACCEPTANCE_TESTS: "<< parameters.skip_tests >>"
      command: |
        yarn gen-certs:e2e
        yarn test:acceptance
  - run:
      when: always
      name: Collect Schemas
      command: |
        mkdir -p << parameters.schema_dir >>
        cp -v --parents apps/*/openapi.json << parameters.schema_dir >>
  - persist_to_workspace:
      root: "<< parameters.schema_dir >>"
      paths:
        - "*/*/openapi.json"
  - store_artifacts:
      path: "<< parameters.schema_dir >>/apps"
      destination: schemas
