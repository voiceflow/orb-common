parameters:
  schema_dir:
    description: Directory to store schemas between jobs
    type: string
    default: "/tmp/next-schemas"
executor: node-executor
steps:
  - attach_workspace:
      at: "<< parameters.schema_dir >>"
  - vfcommon/clone_repo:
      step_name: Clone openapi-schemas repository
      github_username: GITHUB_USERNAME
      github_token: GITHUB_TOKEN
      github_repo_name: openapi-schemas
      github_commit: DEFAULT_COMMIT
      path_to_clone: ~/schemas
  - run:
      name: Update Schemas
      working_directory: "<< parameters.schema_dir >>"
      command: cp -v --parents apps/*/openapi.json ~/schemas
  - run:
      name: Commit Schemas
      working_directory: ~/schemas
      command: |
        git config --global user.email "serviceaccount@voiceflow.com"
        git config --global user.name "Voiceflow"
        git add **/openapi.json
        git diff-index --quiet HEAD || git commit -m "feat: evolve ${CIRCLE_PROJECT_REPONAME} schemas"
        git pull --rebase
        git push